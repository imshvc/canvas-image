class Framebuffer{static version="20250330";static resource={...new Framebuffer.prototype.constructor};static count=0;id=0;canvas=null;width=0;height=0;context=null;static contextAttributes={alpha:!1,colorSpace:"srgb",desynchronized:!1,willReadFrequently:!0};image=null;created=0;updated=0;path=null;ready=!0;locked=!1;dirty=!1;error=null;container=null;spawned=!1;static create(t=1,e=1){let a=Object.setPrototypeOf(Object.assign({},Framebuffer.resource),Framebuffer.prototype);return a.id=Framebuffer.count++,e|=0,0>=(t|=0)||t>8192?(a.error="bad width",a):0>=e||e>8192?(a.error="bad height",a):(a.created=+Date.now(),a.width=t,a.height=e,a.canvas=document.createElement("canvas"),a.canvas.width=t,a.canvas.height=e,a.context=a.canvas.getContext("2d",Framebuffer.contextAttributes),a.canvas.framebuffer=a,null===a.context?(a.error="canvas not supported",a):(a.image=new ImageData(t,e),a.image.data.fill(255),a.sync(),a))}static load(t=null,e=null){if(null===t)return null;"function"!=typeof e&&(e=function(){});let a=Framebuffer.create().lock();a.ready=!1,a.path=t;let i=new Image;return i.onload=function(){let t=i.width,r=i.height;a.ready=!0,a.canvas.width=t,a.canvas.height=r,a.width=t,a.height=r,a.context.drawImage(i,0,0,t,r),a.image=a.context.getImageData(0,0,t,r),a.unlock(),e(a)},i.onerror=function(){a.error="failed to load image",e(a)},i.src=t,a}sync(){return this.context.putImageData(this.image,0,0),this.dirty=!1,this.updated=+Date.now(),this}setColor(t,e,a,i,r){if(this.locked)return this;t|=0,e|=0;let n=this.width*e*4+4*t;return this.image.data[n+0]=a,this.image.data[n+1]=i,this.image.data[n+2]=r,this.dirty=!0,this}getColor(t,e){t|=0,e|=0;let a=this.width*e*4+4*t;return[this.image.data[a+0],this.image.data[a+1],this.image.data[a+2]]}setAlpha(t,e,a){if(this.locked)return this;t|=0,e|=0;let i=this.width*e*4+4*t;return this.image.data[i+3]=a,this.dirty=!0,this}getAlpha(t,e){t|=0,e|=0;let a=this.width*e*4+4*t;return this.image.data[a+3]}spawn(t=null){return null===t||t instanceof Element==!1?(this.error="expects container to be an element",this):null!==this.container?(this.error="resource already spawned",this):(t.append(this.canvas),this.container=t,this.spawned=!0,this)}despawn(){if(null===this.container)return this;let t=this.canvas.parentElement;return null===t||(t.removeChild(this.canvas),this.container=null,this.spawned=!1),this}clear(t=0,e=0,a=0){if(this.locked)return this;for(let i=0;i<this.image.data.length;i+=4)this.image.data[i+0]=t,this.image.data[i+1]=e,this.image.data[i+2]=a;return this}save(t="0.png"){let e=document.createElement("a");return e.href=this.canvas.toDataURL(),e.download=t,e.click(),this}lock(){return this.locked=!0,this}unlock(){return this.locked=!1,this}clone(){let t=Framebuffer.create(this.width,this.height);for(let e=0;e<this.image.data.length;e+=4)t.image.data[e+0]=this.image.data[e+0],t.image.data[e+1]=this.image.data[e+1],t.image.data[e+2]=this.image.data[e+2],t.image.data[e+3]=this.image.data[e+3];return t.sync(),t}getChannel(t=0){0>(t|=0)&&(t=0),t>3&&(t=3);let e=Framebuffer.create(this.width,this.height);for(let a=0;a<e.image.data.length;a+=4)e.image.data[a+0]=this.image.data[a+t],e.image.data[a+1]=this.image.data[a+t],e.image.data[a+2]=this.image.data[a+t];return e.sync(),e}static methods=new Set;static defineMethod(t,e=null){if("string"!=typeof t)throw"specify name (string)";if(Framebuffer.hasMethod(t))throw"duplicate method: "+t;if(t in Framebuffer||t in Framebuffer.prototype||t in Framebuffer.resource)throw"reserved name: "+t;if("function"!=typeof e)throw"specify body (function)";return Framebuffer.methods.add(t),Framebuffer.prototype[t]=e,this}static deleteMethod(t){return Framebuffer.hasMethod(t)&&(Framebuffer.methods.delete(t),delete Framebuffer.prototype[t]),this}static hasMethod(t){return Framebuffer.methods.has(t)&&t in Framebuffer.prototype}}